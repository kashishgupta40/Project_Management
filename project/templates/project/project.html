{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold mb-2">{{ project.name }}</h1>
            {% if project.description %}
                <p class="text-gray-300">{{ project.description }}</p>
            {% endif %}
        </div>
        <div class="flex gap-3">
            <button id="share-project-btn" class="py-2 px-6 bg-gradient-to-r from-purple-600 to-purple-800 hover:from-purple-700 hover:to-purple-900 text-white rounded-lg shadow-md transition">
                <i class="fas fa-share-alt mr-2"></i>Share Project
            </button>
            <a href="{% url 'todolist:add' project.id %}" class="py-2 px-6 bg-gradient-to-r from-emerald-600 to-emerald-800 hover:from-emerald-700 hover:to-emerald-900 text-white rounded-lg shadow-md transition">
                <i class="fas fa-plus mr-2"></i>Add Todo List
            </a>
            <a href="{% url 'project:edit' project.id %}" class="py-2 px-6 bg-gradient-to-r from-sky-600 to-sky-800 hover:from-sky-700 hover:to-sky-900 text-white rounded-lg shadow-md transition">
                <i class="fas fa-edit mr-2"></i>Edit
            </a>
            <a href="{% url 'project:delete' project.id %}" class="py-2 px-6 bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white rounded-lg shadow-md transition">
                <i class="fas fa-trash mr-2"></i>Delete
            </a>
        </div>
    </div>

    <!-- Share Project Modal -->
    <div id="share-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Share Project</h3>
                <button id="close-share-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="share-content" class="space-y-4">
                <p class="text-gray-300">Generating share link...</p>
            </div>
        </div>
    </div>

    <!-- Collaborative Features Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
        <!-- Left Column: Notepad & Comments -->
        <div class="space-y-6">
            <!-- Project Notepad Widget -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fas fa-sticky-note mr-2 text-yellow-400"></i>
                    Project Notepad
                </h2>
                <div class="mb-4">
                    <textarea 
                        id="note-content" 
                        rows="4" 
                        class="w-full p-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none resize-none"
                        placeholder="Write your note here..."
                    ></textarea>
                </div>
                <button id="save-note-btn" class="py-2 px-6 bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white rounded-lg shadow-md transition">
                    <i class="fas fa-save mr-2"></i>Save Note
                </button>
                <div id="notes-list" class="mt-6 space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-gray-400 text-center">Loading notes...</p>
                </div>
            </div>

            <!-- Comments Widget -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fas fa-comments mr-2 text-green-400"></i>
                    Comments
                </h2>
                <div class="mb-4">
                    <textarea 
                        id="comment-message" 
                        rows="3" 
                        class="w-full p-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-green-500 focus:outline-none resize-none"
                        placeholder="Add a comment..."
                    ></textarea>
                </div>
                <button id="post-comment-btn" class="py-2 px-6 bg-gradient-to-r from-green-600 to-green-800 hover:from-green-700 hover:to-green-900 text-white rounded-lg shadow-md transition">
                    <i class="fas fa-paper-plane mr-2"></i>Post Comment
                </button>
                <div id="comments-list" class="mt-6 space-y-4 max-h-96 overflow-y-auto">
                    <p class="text-gray-400 text-center">Loading comments...</p>
                </div>
            </div>
        </div>

        <!-- Right Column: Reminders & Todo Lists -->
        <div class="space-y-6">
            <!-- Reminders Widget -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fas fa-bell mr-2 text-orange-400"></i>
                    Reminders
                </h2>
                <div class="mb-4 space-y-3">
                    <input 
                        type="text" 
                        id="reminder-title" 
                        class="w-full p-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-orange-500 focus:outline-none"
                        placeholder="Reminder title..."
                    />
                    <input 
                        type="datetime-local" 
                        id="reminder-datetime" 
                        class="w-full p-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-orange-500 focus:outline-none"
                    />
                </div>
                <button id="add-reminder-btn" class="py-2 px-6 bg-gradient-to-r from-orange-600 to-orange-800 hover:from-orange-700 hover:to-orange-900 text-white rounded-lg shadow-md transition">
                    <i class="fas fa-plus mr-2"></i>Add Reminder
                </button>
                <div id="reminders-list" class="mt-6 space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-gray-400 text-center">Loading reminders...</p>
                </div>
            </div>

            <!-- Todo Lists -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg">
                <h2 class="text-2xl font-bold mb-4">Todo Lists</h2>
                {% if project.todolists.all %}
                    <div class="grid grid-cols-1 gap-4">
                        {% for todolist in project.todolists.all %}
                            <div class="py-4 px-4 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                                <a href="{% url 'todolist:todolist' project.id todolist.id %}">
                                    <h3 class="text-xl font-semibold mb-2">{{ todolist.name }}</h3>
                                    {% if todolist.description %}
                                        <p class="text-sm text-gray-300">{{ todolist.description|truncatechars:100 }}</p>
                                    {% endif %}
                                </a>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-400 text-center">No todo lists yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Files Section -->
    <div class="mt-8 bg-slate-800 rounded-lg p-6 shadow-lg">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold">Files</h2>
            <a href="{% url 'project:upload_file' project.id %}" class="py-2 px-6 bg-gradient-to-r from-slate-600 to-slate-800 hover:from-slate-700 hover:to-slate-900 text-white rounded-lg shadow-md transition">
                <i class="fas fa-upload mr-2"></i>Upload File
            </a>
        </div>
        {% if project.files.all %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {% for projectfile in project.files.all %}
                    <div class="py-4 px-4 bg-gray-700 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2 truncate">{{ projectfile.name }}</h3>
                        <div class="flex gap-2">
                            <a href="{{ projectfile.attachment.url }}" target="_blank" class="text-sm text-blue-400 hover:text-blue-300">
                                <i class="fas fa-download mr-1"></i>Download
                            </a>
                            <span class="text-gray-500">|</span>
                            <a href="{% url 'project:delete_file' project.id projectfile.id %}" class="text-sm text-red-400 hover:text-red-300">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-400 text-center">No files uploaded yet.</p>
        {% endif %}
    </div>
</div>

<!-- Load API Service -->
<script src="{% static 'project/api.js' %}"></script>

<!-- Collaborative Features JavaScript -->
<script>
    const PROJECT_ID = '{{ project.id }}';

    // Share Project Functionality
    document.addEventListener('DOMContentLoaded', function() {
        const shareBtn = document.getElementById('share-project-btn');
        const shareModal = document.getElementById('share-modal');
        const closeShareModal = document.getElementById('close-share-modal');
        const shareContent = document.getElementById('share-content');

        shareBtn?.addEventListener('click', async function() {
            shareModal.classList.remove('hidden');
            shareContent.innerHTML = '<p class="text-gray-300">Generating share link...</p>';

            const result = await ShareAPI.shareProject(PROJECT_ID);
            
            if (result.success) {
                const shareData = result.data;
                shareContent.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Share URL:</label>
                            <div class="flex gap-2">
                                <input type="text" id="share-url-input" value="${shareData.share_url}" readonly 
                                    class="flex-1 p-2 bg-gray-700 text-white rounded border border-gray-600">
                                <button onclick="copyToClipboard('${shareData.share_url}')" 
                                    class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded transition">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <a href="${shareData.whatsapp_url}" target="_blank" 
                                class="flex-1 py-2 px-4 bg-green-600 hover:bg-green-700 text-white rounded text-center transition">
                                <i class="fab fa-whatsapp mr-2"></i>Share on WhatsApp
                            </a>
                            <a href="${shareData.mailto_url}" 
                                class="flex-1 py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded text-center transition">
                                <i class="fas fa-envelope mr-2"></i>Share via Email
                            </a>
                        </div>
                    </div>
                `;
            } else {
                shareContent.innerHTML = `<p class="text-red-400">Error: ${result.error}</p>`;
            }
        });

        closeShareModal?.addEventListener('click', function() {
            shareModal.classList.add('hidden');
        });

        shareModal?.addEventListener('click', function(e) {
            if (e.target === shareModal) {
                shareModal.classList.add('hidden');
            }
        });

        // Copy to clipboard function
        window.copyToClipboard = function(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('Share URL copied to clipboard!');
            });
        };

        // Load Notes
        loadNotes();
        
        // Load Comments
        loadComments();
        
        // Load Reminders
        loadReminders();

        // Save Note
        document.getElementById('save-note-btn')?.addEventListener('click', async function() {
            const content = document.getElementById('note-content').value.trim();
            if (!content) {
                alert('Please enter a note');
                return;
            }

            const result = await NotesAPI.createNote(PROJECT_ID, content);
            if (result.success) {
                document.getElementById('note-content').value = '';
                loadNotes();
            } else {
                alert('Error saving note: ' + result.error);
            }
        });

        // Post Comment
        document.getElementById('post-comment-btn')?.addEventListener('click', async function() {
            const message = document.getElementById('comment-message').value.trim();
            if (!message) {
                alert('Please enter a comment');
                return;
            }

            const result = await CommentsAPI.createComment(PROJECT_ID, message);
            if (result.success) {
                document.getElementById('comment-message').value = '';
                loadComments();
            } else {
                alert('Error posting comment: ' + result.error);
            }
        });

        // Add Reminder
        document.getElementById('add-reminder-btn')?.addEventListener('click', async function() {
            const title = document.getElementById('reminder-title').value.trim();
            const datetime = document.getElementById('reminder-datetime').value;
            
            if (!title || !datetime) {
                alert('Please fill in both title and datetime');
                return;
            }

            const result = await RemindersAPI.createReminder(PROJECT_ID, title, datetime);
            if (result.success) {
                document.getElementById('reminder-title').value = '';
                document.getElementById('reminder-datetime').value = '';
                loadReminders();
            } else {
                alert('Error creating reminder: ' + result.error);
            }
        });
    });

    // Load and display notes
    async function loadNotes() {
        const notesList = document.getElementById('notes-list');
        const result = await NotesAPI.getNotes(PROJECT_ID);
        
        if (result.success) {
            const notes = result.data.results || result.data;
            if (notes.length === 0) {
                notesList.innerHTML = '<p class="text-gray-400 text-center">No notes yet.</p>';
            } else {
                notesList.innerHTML = notes.map(note => `
                    <div class="p-4 bg-gray-700 rounded-lg">
                        <p class="text-white mb-2">${escapeHtml(note.content)}</p>
                        <p class="text-xs text-gray-400">${formatDateTime(note.created_at)}</p>
                        <button onclick="deleteNote('${note.id}')" class="mt-2 text-xs text-red-400 hover:text-red-300">
                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                    </div>
                `).join('');
            }
        } else {
            notesList.innerHTML = '<p class="text-red-400 text-center">Error loading notes</p>';
        }
    }

    // Load and display comments
    async function loadComments() {
        const commentsList = document.getElementById('comments-list');
        const result = await CommentsAPI.getComments(PROJECT_ID);
        
        if (result.success) {
            const comments = result.data.results || result.data;
            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="text-gray-400 text-center">No comments yet.</p>';
            } else {
                commentsList.innerHTML = comments.map(comment => `
                    <div class="p-4 bg-gray-700 rounded-lg">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <p class="font-semibold text-white">${escapeHtml(comment.user_name || comment.user_email)}</p>
                                <p class="text-xs text-gray-400">${formatDateTime(comment.timestamp)}</p>
                            </div>
                            <button onclick="deleteComment('${comment.id}')" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <p class="text-gray-300">${escapeHtml(comment.message)}</p>
                    </div>
                `).join('');
            }
        } else {
            commentsList.innerHTML = '<p class="text-red-400 text-center">Error loading comments</p>';
        }
    }

    // Load and display reminders
    async function loadReminders() {
        const remindersList = document.getElementById('reminders-list');
        const result = await RemindersAPI.getReminders(PROJECT_ID);
        
        if (result.success) {
            const reminders = result.data.results || result.data;
            if (reminders.length === 0) {
                remindersList.innerHTML = '<p class="text-gray-400 text-center">No reminders yet.</p>';
            } else {
                remindersList.innerHTML = reminders.map(reminder => {
                    let bgColor = 'bg-gray-700';
                    if (reminder.status === 'due_soon') {
                        bgColor = 'bg-yellow-900 border-2 border-yellow-500';
                    } else if (reminder.status === 'overdue') {
                        bgColor = 'bg-red-900 border-2 border-red-500';
                    }
                    
                    return `
                        <div class="p-4 ${bgColor} rounded-lg">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-white">${escapeHtml(reminder.title)}</h4>
                                    <p class="text-xs text-gray-400 mt-1">${formatDateTime(reminder.reminder_datetime)}</p>
                                    <span class="inline-block mt-2 px-2 py-1 text-xs rounded ${getStatusBadgeClass(reminder.status)}">
                                        ${escapeHtml(reminder.status_display || reminder.status)}
                                    </span>
                                </div>
                                <button onclick="deleteReminder('${reminder.id}')" class="text-red-400 hover:text-red-300 ml-2">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        } else {
            remindersList.innerHTML = '<p class="text-red-400 text-center">Error loading reminders</p>';
        }
    }

    // Delete functions
    async function deleteNote(noteId) {
        if (!confirm('Are you sure you want to delete this note?')) return;
        const result = await NotesAPI.deleteNote(noteId);
        if (result.success) {
            loadNotes();
        } else {
            alert('Error deleting note: ' + result.error);
        }
    }

    async function deleteComment(commentId) {
        if (!confirm('Are you sure you want to delete this comment?')) return;
        const result = await CommentsAPI.deleteComment(commentId);
        if (result.success) {
            loadComments();
        } else {
            alert('Error deleting comment: ' + result.error);
        }
    }

    async function deleteReminder(reminderId) {
        if (!confirm('Are you sure you want to delete this reminder?')) return;
        const result = await RemindersAPI.deleteReminder(reminderId);
        if (result.success) {
            loadReminders();
        } else {
            alert('Error deleting reminder: ' + result.error);
        }
    }

    // Utility functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
        });
    }

    function getStatusBadgeClass(status) {
        switch(status) {
            case 'due_soon':
                return 'bg-yellow-600 text-yellow-100';
            case 'overdue':
                return 'bg-red-600 text-red-100';
            case 'completed':
                return 'bg-green-600 text-green-100';
            default:
                return 'bg-gray-600 text-gray-100';
        }
    }
</script>
{% endblock %}
